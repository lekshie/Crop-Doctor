<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crop Doctor</title>
    
    <!-- --- PWA MANIFEST AND THEME CONFIGURATION --- -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#365314">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- -------------------------------------------- -->

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fee7; /* Light green background */
        }
        /* Ensures the app looks and feels edge-to-edge on mobile */
        @media (max-width: 640px) {
            #app-container {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0.5rem !important; /* Reduced padding on mobile */
            }
            .h-full-screen {
                min-height: 100vh;
                height: 100vh;
            }
        }
        .h-full-screen {
             /* Fallback for better desktop presentation */
             min-height: 90vh; 
        }
    </style>
</head>
<!-- h-screen and p-0 on mobile for edge-to-edge feel -->
<body class="h-full-screen flex items-center justify-center bg-f7fee7 p-2 sm:p-8">

    <!-- h-full ensures it fills the viewport vertically on small screens -->
    <div id="app-container" class="w-full h-full-screen max-w-5xl bg-white shadow-none sm:shadow-2xl sm:rounded-xl p-4 sm:p-10 transition-all duration-300 overflow-y-auto">

        <!-- Header -->
        <header class="text-center mb-6 pt-4 sm:pt-0">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-green-800">🌿AI Crop Doctor</h1>
            <p class="text-lg text-green-600 mt-1">Capture a leaf for instant diagnosis. hindi ko to binili guys!! (lexy)</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Input Column (Left) -->
            <div class="space-y-6">
                <h2 class="text-xl font-semibold text-green-700 border-b pb-2">1. Capture or Upload Image</h2>

                <!-- File Input (Now Camera-Focused) -->
                <div class="relative border-2 border-dashed border-green-400 rounded-xl p-6 hover:border-green-600 transition-colors cursor-pointer bg-green-50/50">
                    <!-- Added capture="environment" to launch the back camera directly -->
                    <input type="file" id="leafFileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(event)" capture="environment">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.69 4h2.62a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <p class="mt-2 text-sm text-green-700"><span class="font-bold">Tap to launch camera</span> or browse files</p>
                        <p class="text-xs text-green-500">PNG, JPG, up to 4MB</p>
                    </div>
                </div>

                <!-- Image Preview -->
                <div class="mt-4 border border-green-300 rounded-xl overflow-hidden bg-green-50 p-4 shadow-inner">
                    <h3 class="text-lg font-medium text-green-800 mb-3">Image Preview:</h3>
                    <img id="imagePreview" src="https://placehold.co/600x400/bbf7d0/16a34a?text=Upload+a+Leaf" alt="Leaf Preview" class="w-full h-48 object-cover rounded-lg shadow-md transition-opacity duration-500 opacity-100">
                    <p id="fileNameDisplay" class="text-sm mt-2 text-center text-green-600 italic">No file selected.</p>
                </div>

                <!-- Scan Button -->
                <button id="scanButton" onclick="scanLeaf()" disabled class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition-all duration-200 disabled:bg-green-300 disabled:cursor-not-allowed">
                    <span id="buttonText">Analyze Leaf for Disease</span>
                    <div id="loader" class="hidden inline-block h-5 w-5 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div>
                </button>
                
                 <!-- User ID Display -->
                <p id="userIdDisplay" class="text-xs text-center text-gray-500 pt-2 break-all">
                    User ID: Connecting...
                </p>
            </div>

            <!-- Output Column (Right) -->
            <div class="space-y-8">
                <!-- Diagnosis & Treatment Section -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-green-700 border-b pb-2">2. Diagnosis & Treatment</h2>

                    <!-- Result Display Area -->
                    <div id="resultContainer" class="min-h-56 bg-white border border-green-200 rounded-xl p-4 sm:p-6 shadow-md">
                        <p id="initialMessage" class="text-center text-green-500 mt-4">
                            Results will appear here after analysis. Upload an image to start.
                        </p>
                        <!-- Analysis content will be injected here -->
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline" id="errorText">Something went wrong.</span>
                    </div>
                </div>

                <!-- Scan History Section -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-green-700 border-b pb-2">3. Scan History</h2>
                    <div id="historyContainer" class="max-h-80 overflow-y-auto pr-2">
                        <p class="text-center text-gray-400 italic" id="historyLoading">Loading history...</p>
                        <!-- History items will be injected here -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-xs text-gray-400 mt-8 mb-4">
            Powered by LEXY AI for image analysis.(blehhhh)
        </footer>
    </div>

    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; 
        let appId = 'default-app-id'; 

        // Global API configuration
        const API_MODEL = "gemini-2.5-flash-preview-05-20";
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent`;
        const apiKey = ""; // Canvas environment provides this if empty

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // IMPORTANT: This registers the service_worker.js file.
                navigator.serviceWorker.register('/service_worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }


        // --- Utility Functions ---

        /**
         * Converts a File object into a base64 encoded string.
         * @param {File} file - The image file to convert.
         * @returns {Promise<string>} - The base64 data string (without mime prefix).
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extract base64 part (remove "data:image/jpeg;base64,")
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /**
         * Generic function to make a fetch request with exponential backoff.
         * @param {string} url - The base API endpoint URL (without key).
         * @param {Object} payload - The request body payload.
         * @param {number} retries - Max number of retries.
         * @param {number} delay - Initial delay in milliseconds.
         * @returns {Promise<Object>} - The JSON response body.
         */
        const makeApiCall = async (url, payload, retries = 3, delay = 1000) => {
            // FIX FOR 403 ERROR: Mandated pattern for Canvas API key injection.
            const fetchUrl = url + `?key=${apiKey}`; 
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(fetchUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests, retry with backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        // Throw the error with the exact status and message from the API
                        throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                    }

                    return response.json();

                } catch (error) {
                    if (i === retries - 1) {
                        // If all retries fail, throw the error
                        throw new Error(`API call failed after ${retries} attempts: ${error.message}`);
                    }
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        };

        /**
         * Sets the loading state on the button and UI.
         * @param {boolean} isLoading - Whether to show the loading state.
         */
        const setLoadingState = (isLoading) => {
            const button = document.getElementById('scanButton');
            const buttonText = document.getElementById('buttonText');
            const loader = document.getElementById('loader');
            const fileInput = document.getElementById('leafFileInput');

            if (isLoading) {
                buttonText.textContent = 'Analyzing...';
                loader.classList.remove('hidden');
                button.disabled = true;
                fileInput.disabled = true;
                document.getElementById('errorMessage').classList.add('hidden');
            } else {
                buttonText.textContent = 'Analyze Leaf for Disease';
                loader.classList.add('hidden');
                const file = fileInput.files[0];
                button.disabled = !file; // Re-enable if file is present
                fileInput.disabled = false;
            }
        };

        /**
         * Renders the analysis results from the model's structured response to the main diagnosis area.
         * @param {Object} data - The parsed JSON response from the model.
         */
        const renderResults = (data) => {
            const container = document.getElementById('resultContainer');
            document.getElementById('initialMessage').classList.add('hidden');

            const isHealthy = data.diagnosis.toLowerCase().includes('healthy');
            const badgeColor = isHealthy ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const icon = isHealthy ? '🌱' : '⚠️';

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center space-x-3 pb-3 border-b border-green-200">
                        <span class="text-3xl">${icon}</span>
                        <h3 class="text-2xl font-bold text-gray-800">Diagnosis Summary</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg border border-gray-100 bg-white shadow-sm">
                            <p class="text-sm font-medium text-gray-500">Plant Type</p>
                            <p class="text-lg font-semibold text-green-700">${data.plantType || 'Unknown'}</p>
                        </div>
                        <div class="p-3 rounded-lg border border-gray-100 bg-white shadow-sm">
                            <p class="text-sm font-medium text-gray-500">Confidence</p>
                            <p class="text-lg font-semibold text-green-700">${data.confidenceScore || 'N/A'}</p>
                        </div>
                    </div>

                    <div class="p-4 rounded-xl ${badgeColor} shadow-md">
                        <p class="text-sm font-medium">STATUS:</p>
                        <p class="text-2xl font-extrabold">${data.diagnosis}</p>
                    </div>

                    <div>
                        <h4 class="text-xl font-semibold text-green-700 mb-2 mt-4">Cause</h4>
                        <p class="text-gray-600">${data.cause}</p>
                    </div>

                    <div>
                        <h4 class="text-xl font-semibold text-green-700 mb-3 mt-4">Treatment Recommendations</h4>
                        <ol class="list-decimal list-inside space-y-3 pl-2">
                            ${data.treatmentRecommendations.map(rec => `<li class="text-gray-600 pl-1">${rec}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
        };

        /**
         * Saves a successful scan result to Firestore.
         * @param {Object} data - The parsed JSON response from the model.
         */
        const saveScanResult = async (data) => {
            if (!db) {
                console.error("Firestore not initialized. Cannot save scan.");
                return;
            }

            try {
                const scanData = {
                    ...data,
                    userId: userId,
                    timestamp: serverTimestamp() 
                };
                
                // Firestore path: /artifacts/{appId}/users/{userId}/scans
                const scansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/scans`);
                await addDoc(scansCollectionRef, scanData);
                console.log("Scan result successfully saved to Firestore.");

            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };

        /**
         * Renders the history of scans from Firestore.
         * @param {Array<Object>} scans - Array of scan history objects.
         */
        const renderHistory = (scans) => {
            const container = document.getElementById('historyContainer');
            if (scans.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 italic">No previous scans found.</p>`;
                return;
            }

            // Sort by timestamp descending (newest first)
            scans.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            const historyHtml = scans.map((scan) => {
                const isHealthy = scan.diagnosis.toLowerCase().includes('healthy');
                const bgColor = isHealthy ? 'bg-green-50' : 'bg-red-50';
                const borderColor = isHealthy ? 'border-green-400' : 'border-red-400';
                const icon = isHealthy ? '✅' : '🚨';
                
                // Format timestamp
                const date = scan.timestamp?.toDate ? scan.timestamp.toDate() : new Date();
                const timeStr = date.toLocaleString();


                return `
                    <div class="p-3 border-l-4 ${borderColor} ${bgColor} rounded-lg shadow-sm mb-3">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 flex items-center">
                                <span class="mr-2 text-lg">${icon}</span> ${scan.diagnosis}
                            </h4>
                            <span class="text-xs text-gray-500 ml-4">${timeStr}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Plant: <span class="font-medium">${scan.plantType}</span>, Confidence: ${scan.confidenceScore}</p>
                        <p class="text-xs text-gray-500 italic mt-1">Cause: ${scan.cause}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHtml;
        };
        
        /**
         * Subscribes to the user's scan history in Firestore.
         */
        const loadScanHistory = () => {
             if (!db || !userId || userId === 'anonymous') {
                document.getElementById('historyContainer').innerHTML = `<p class="text-center text-gray-400 italic">History will load after sign-in.</p>`;
                return;
            }

            // Firestore path: /artifacts/{appId}/users/{userId}/scans
            const scansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/scans`);
            const scansQuery = query(scansCollectionRef);

            // Set up real-time listener
            onSnapshot(scansQuery, (snapshot) => {
                const scans = [];
                snapshot.forEach(doc => {
                    scans.push(doc.data());
                });
                renderHistory(scans);
            }, (error) => {
                console.error("Error listening to history data: ", error);
                document.getElementById('historyContainer').innerHTML = `<p class="text-center text-red-500">Failed to load history.</p>`;
            });
        };

        // --- Main Logic ---

        /**
         * Global function accessible from HTML to start the leaf scanning process.
         */
        window.scanLeaf = async () => {
            const fileInput = document.getElementById('leafFileInput');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('errorText').textContent = "Please capture or select an image file first.";
                document.getElementById('errorMessage').classList.remove('hidden');
                return;
            }

            // Simple file size check (4MB limit)
            if (file.size > 4 * 1024 * 1024) {
                 document.getElementById('errorText').textContent = "File size exceeds 4MB. Please upload a smaller image.";
                 document.getElementById('errorMessage').classList.remove('hidden');
                 return;
            }

            setLoadingState(true);
            try {
                const base64Image = await fileToBase64(file);
                const mimeType = file.type;

                // The prompt asks the model to provide a structured JSON response
                const userPrompt = "Analyze the provided image of a plant leaf. Identify the plant type, diagnose the potential disease (or state 'Healthy' if none is found), describe the cause, and give 3 specific, actionable treatment recommendations. Provide the output ONLY as a single JSON object conforming to the schema.";

                const structuredSchema = {
                    type: "OBJECT",
                    properties: {
                        "diagnosis": { "type": "STRING", "description": "The identified disease name or 'Healthy'." },
                        "plantType": { "type": "STRING", "description": "The likely type of plant or crop." },
                        "confidenceScore": { "type": "STRING", "description": "A confidence score for the diagnosis (e.g., '95%')." },
                        "cause": { "type": "STRING", "description": "The underlying cause of the disease (e.g., fungus, bacteria, nutrient deficiency)." },
                        "treatmentRecommendations": {
                            "type": "ARRAY",
                            "description": "Three specific, actionable steps for treatment or prevention.",
                            "items": { "type": "STRING" }
                        }
                    },
                    required: ["diagnosis", "plantType", "confidenceScore", "cause", "treatmentRecommendations"]
                };

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: structuredSchema,
                    },
                };

                const result = await makeApiCall(API_BASE_URL, payload);

                // Safely parse the JSON string result
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                     throw new Error("Received an empty or malformed response from the model.");
                }

                const parsedData = JSON.parse(jsonText);
                
                // 1. Render results to the screen
                renderResults(parsedData);
                
                // 2. Save result to history
                await saveScanResult(parsedData);

            } catch (error) {
                console.error("Leaf scanning failed:", error);
                // Display user-friendly error
                document.getElementById('errorText').textContent = `Analysis failed: ${error.message.includes('403') ? 'Permission Denied (API Key Issue)' : error.message}. Please try a different image.`;
                document.getElementById('errorMessage').classList.remove('hidden');
            } finally {
                setLoadingState(false);
            }
        };


        /**
         * Global function to handle image preview and enable the scan button.
         * @param {Event} event - The change event from the file input.
         */
        window.previewImage = (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const scanButton = document.getElementById('scanButton');
            // Clear current diagnosis display
            document.getElementById('resultContainer').innerHTML = `<p id="initialMessage" class="text-center text-green-500 mt-4">Results will appear here after analysis. Upload an image to start.</p>`;
            document.getElementById('initialMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(file);
                fileNameDisplay.textContent = file.name;
                scanButton.disabled = false;
            } else {
                preview.src = "https://placehold.co/600x400/bbf7d0/16a34a?text=Upload+a+Leaf";
                fileNameDisplay.textContent = "No file selected.";
                scanButton.disabled = true;
            }
        };

        // --- Firebase Initialization (Required for Canvas Environment) ---

        const initializeFirebase = async () => {
            try {
                setLogLevel('Debug');
                // Retrieve global variables provided by the Canvas environment
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set global userId and display it
                userId = auth.currentUser?.uid || 'anonymous';
                document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                console.log("Firebase initialized. App ID:", appId, "User ID:", userId);
                
                // Load the history once authenticated
                loadScanHistory();

            } catch (e) {
                console.error("Firebase initialization or authentication failed:", e);
                document.getElementById('userIdDisplay').textContent = "User ID: Auth Failed";
            }
        };

        window.onload = initializeFirebase;

    </script>
</body>
</html>
